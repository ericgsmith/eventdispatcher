<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Drupal 8 and the Symfony Event Dispatche</title>

    <meta name="description" content="Drupal 8 and the Symfony Event Dispatcher">
    <meta name="author" content="Eric Smith">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/league.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/styles/github.css">

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->

      <style>
          pre,
          code {
              padding: 0!important;
              width: 100%!important;
              margin: 0!important;
          }

        li {
          white-space: nowrap;
        }
      </style>
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
            <section>
                <h1>Drupal 8 and the Symfony Event Dispatcher</h1>
                <p>Eric Smith / <a href="http://twitter.com/ericgsmith">@ericgsmith</a></p>
                <aside class="notes">
                    Intro / see how many people are using d8.
                </aside>
            </section>

        </section>

            <section>
                <ol>
                    <li>What is it / why it's useful</li>
                    <li>Sending an event</li>
                    <li>Responding to an event</li>
                </ol>
        </section>


        <section>
            <h2>Detour 1: About me</h2>
        </section>

        <section>
          <h2>Why should you care?</h2>
          <p>No more hook_boot</p>
          <p>No more hook_init</p>
          <p>No more hook_exit</p>
          <aside class="notes">
            Hook system - one of the first things we learn about drupal.
            A lot of invoked hooks are gone. Might be completely gone for D9.
            replaced by the event dispatcher.
          </aside>
        </section>

        <section>
          <section>
            <h2>Events</h2>
            <blockquote cite="https://en.wikipedia.org/wiki/Event_(computing)">
              <p>... an event is an action or occurrence recognised by software that may be handled by the software.</p>
            </blockquote>
            <aside class="notes">
              Think javascript. Responding to events is something we often do.
              These events can be anything.
            </aside>
          </section>

            <section>
                <h2>Events</h2>
                <blockquote><p>Something happened</p></blockquote>
                <aside class="notes">To see why its useful lets look at what we might have done</aside>
            </section>

          <section>
            <h2>What we might have done</h2>
            <p>We have a form that collects a name and email address.</p>
            <ul>
              <li>Send an email to the user</li>
                <li>Log the submission</li>
              <li>Add the user to our CRM</li>
              <li>Add the user to our newsletter</li>
              <li>Tweet their details to the company fridge</li>
            </ul>
              <aside class="notes">
                  .. and thats just what we know now that we want to do.
              </aside>
          </section>

          <section>
            <pre><code data-trim class="php">
public function submitForm(array &$form, FormStateInterface $form_state) {
  $name = $form_state->getValue('name');
  $email = $form_state->getValue('email');

  $this->mailer->mail('example', 'signup_form', $email, .... ['name' => $name]);

  $this->logger->log('notice', 'Registration of interest submitted...');

  $this->crmManager->subscribe($name, $email);

  $this->mailChimpSubscriptionManager->add($name, $email);

  $tweet = TweetFactory::create('blah blah ' . $name . ' blah blah');
  $this->tweeter->tweet($tweet);
}
</code></pre>
          </section>

          <section>
            <h2>This is bad</h2>
            <ul>
              <li>Submit method is doing too many things</li>
              <li>Form class knows too many things</li>
              <li>Hard to maintain</li>
              <li>Hard to reuse</li>
            </ul>
          </section>

            <section>
                <img src="form%20dep%20graph.svg" />
            </section>

          <section>
            <h2>Symfony Event Dispatcher</h2>
            <img src="gatwick.jpg" />
            <aside class="notes">
              A component - drupal is more modern and component based.
              Component - a bit of functionality we can use.
              Example of the mediator design pattern.
              Object the encapsulates the communication of other objects.

              Mediator promotes loose coupling by keeping objects from referring to each other explicitly

              Drupal is using ContainerAwareEventDispatcher

              3 step process - listen, notify, execute.
            </aside>
          </section>

            <section>
                <img src="after%20graph.svg" />
            </section>
        </section>

        <section>
            <section>
                <h2>Detour 2: Service container</h2>
            </section>

            <section>
                <h2>Service:</h2>
              <blockquote>
                <p>Any PHP object that performs some sort of "global" task.</p>
                <small><cite><a href="http://symfony.com/doc/current/book/service_container.html">http://symfony.com/doc/current/book/service_container.html</a></cite></small>
              </blockquote>
            </section>

          <section>
            <h2>Dependency Injection:</h2>
            <p>Inject dependencies.</p>
          </section>

          <section>
            <h2>Not Dependency Injection:</h2>
            <pre><code data-trim class="php">
public function myMethod() {
  $mailer = new Mailhandler();
  $mailer->send('This is bad.');
}
              </code></pre>
          </section>

          <section>
            <h2>Dependency Injection:</h2>
            <pre><code data-trim class="php">
protected $mailer;

public function __construct(MailHandlerInterface $mailer) {
  $this->mailer = $mailer;
}

public function myMethod() {
  $this->mailer->send('This is better.');
}
            </code></pre>
          </section>

            <section>
                <h2>How it works:</h2>
              <div style="display: flex; flex-flow: row; justify-content: space-around;">
                <div style="width:33%">
                  <h3>Configuration</h3>
                  <img src="config.png" />
                </div>
                <div style="width:33%">
                  <h3>Magic</h3><img src="magic.gif" style="max-width: 100%;" />
                </div>
                <div style="width:33%">
                  <h3>Service Container</h3>
                  <img src="sc.svg" />
                </div>
              </div>
            </section>
        </section>

        <section>
          <section>
            <h2>Dispatching an event</h2>
            <ol>
              <li>Static event class</li>
              <li>Extend the event class</li>
              <li>Dispatch the event</li>
            </ol>
            <aside class="notes">You have a module, doing something, you want to tell the world about it.
            Maybe it needs to be altered. Maybe its your own code and you need to keep it
            clean and tidy.</aside>
          </section>

          <section>
            <h2>The Static Events Class</h2>
            <pre><code data-trim class="php">
final class ExampleModuleEvents {

  /** docBlock */
  const SIGNUP_FORM_SUBMIT = 'module_name.signup_form_submit';
}
            </code></pre>
            <aside class="notes">This doesn't do anything... Used for docs / console. Remember how we had modulename.api</aside>
          </section>

          <section>
            <h2>Extend the event class</h2>
            <pre><code data-trim class="php">
use Symfony\Component\EventDispatcher\Event;

class SignupFormEvent extends Event {

  protected $name;
  protected $email;

  public function __construct($name, $email) {
    $this->name = $name;
    $this->email = $email;
  }

  public function getName() { return $this->name; }
  public function getEmail() { return $this->email; }
}
            </code></pre>
          </section>

          <section>
            <h2>Dispatch the event</h2>
            <pre><code data-trim class="php">
public function submitForm(array &$form, FormStateInterface $form_state) {
  $name = $form_state->getValue('name');
  $email = $form_state->getValue('email');

  $event = new SignupFormEvent($name, $email);

  $this->eventDispatcher->dispatch(ExampleModuleEvents::SIGNUP_FORM_SUBMIT, $event);
}
            </code></pre>
            <aside class="notes"></aside>
          </section>
        </section>

        <section>
            <section>
                <h2>Detour 3: Forms</h2>
            </section>
            <section>
                <h2>FormBase</h2>
                <ul>
                    <li>Implements FormInterface</li>
                    <li>Implements ContainerInjectionInterface</li>
                </ul>
            </section>

            <section>
                <h2>ContainerInjectionInterface</h2>
            <pre><code data-trim class="php">
public static function create(ContainerInterface $container) {
  return new static();
}
            </code></pre>
            </section>

            <section>
                <h2>ContainerInjectionInterface</h2>
            <pre><code data-trim class="php">
protected $mailHandler;

public function __construct(MailHandlerInterface $mail_handler) {
  $this->mailHandler = $mail_handler;
}

public static function create(ContainerInterface $container) {
  return new static(
    $container->get('mailhandler')
  );
}
            </code></pre>
            </section>

            <section>
                <h2>FormInterface</h2>
            <pre><code data-trim class="php">
public function buildForm(array $form, FormStateInterface $form_state);

public function validateForm(array &$form, FormStateInterface $form_state);

public function submitForm(array &$form, FormStateInterface $form_state);
            </code></pre>
            </section>
        </section>

        <section>
          <section>
            <h2>Listen for events</h2>
            <ul>
              <li>Add to services.yaml</li>
              <li>Implement EventSubscriberInterface</li>
              <li>Implement getSubscribers method</li>
            </ul>
            <aside class="notes">Now to recieve. Remember we are using the container aware dispatcher.</aside>
          </section>

          <section>
            <h2>services.yaml</h2>
            <pre><code data-trim class="yaml">
services:
  example_crm_module.crm_subscriber:
  class: "Drupal\example_crm_module\EventSubscriber\CRMSubscriber"
  arguments: ['@crm_manager']
  tags:
    - { name: event_subscriber }
            </code></pre>
          </section>

          <section>
            <h2>Implement EventSubscriberInterface</h2>
            <pre><code data-trim class="php">
use Symfony\Component\EventDispatcher\EventSubscriberInterface;

class CRMSubscriber implements EventSubscriberInterface {
  protected $crmManager;

  public function __construct($crmManager) {
    $this->crmManager = $crmManager;
  };

  public static function getSubscribedEvents() {
    $events['module_name.signup_form'][] = array('crmRegister', 0);
    return $events;
  }

  public function crmRegister(SignupFormEvent $event) { ... }
}
            </code></pre>
          </section>

          <section>
            <pre><code data-trim class="php">
public function crmRegister($event) {
  $this->crmManager->subscribe($event->getName(), $event->getEmail());
}
            </code></pre>
          </section>
        </section>

        <section>
            <h2>Why is this good?</h2>
          <ul>
            <li>Single Responsibility Principle</li>
            <li>Open / Closed</li>
            <li>Dependency Inversion</li>
          </ul>
        </section>

        <section>
            <h2>What is Core doing...</h2>
            <ul>
                <li>hook_entity_save, delete, etc</li>
                <li>hook_block_view, etc</li>
                <li>hook_cron</li>
                <li>hook_install</li>
                <li>hook_preprocess</li>
            </ul>
        </section>

        <section>
          <h2>What is Core doing...</h2>
          <ul>
            <li>ConfigEvents::DELETE, IMPORT, SAVE..</li>
            <li>EntityTypeEvents::CREATE, UPDATE, DELETE..</li>
            <li>KernelEvents::REQUEST, RESPONSE, TERMINATE..</li>
            <li>RoutingEvents::ALTER, DYNAMIC, ETC..</li>
          </ul>
        </section>

        <section>
            Add video.
        </section>

        <section>
          <h2>Questions?</h2>
          <p>Eric Smith / <a href="http://twitter.com/ericgsmith">@ericgsmith</a></p>
        </section>
      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
