<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Drupal 8 and the Symfony Event Dispatche</title>

    <meta name="description" content="Drupal 8 and the Symfony Event Dispatcher">
    <meta name="author" content="Eric Smith">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h1>Drupal 8 and the Symfony Event Dispatcher</h1>
          <p>Eric Smith / <a href="http://twitter.com/ericgsmith">@ericgsmith</a></p>
          <aside class="notes">
            Intro / see how many people are using d8.
          </aside>
        </section>

        <section>
          <ul>
            <li>What is it / why it's useful</li>
            <li>Sending an event</li>
            <li>Responding to an event</li>
          </ul>
        </section>

        <section>
          <h2>Why should you care?</h2>
          <p>No more hook_boot</p>
          <p>No more hook_init</p>
          <p>No more hook_exit</p>
          <aside class="notes">
            A lot of invoked hooks are gone. Might be completely gone for D9.
          </aside>
        </section>

        <section>
          <section>
            <h2>Events</h2>
            <blockquote cite="https://en.wikipedia.org/wiki/Event_(computing)">
              <p>... an event is an action or occurrence recognised by software that may be handled by the software.</p>
            </blockquote>
            <aside class="notes">
              Think javascript. Responding to events is something we often do.
              These events can be anything.
            </aside>
          </section>

          <section>
            <h2>What we might have done</h2>
            <p>We have a form that collects a name and email address.</p>
            <ul>
              <li>Send an email to the user</li>
              <li>Add the user to our CRM</li>
              <li>Add the user to our newsletter</li>
              <li>Tweet their details to the company fridge</li>
            </ul>
          </section>

          <section>
            <pre><code>
public function submitForm(array &$form, FormStateInterface $form_state) {
  $name = $form_state->getValue('name');
  $email = $form_state->getValue('email');

  $container = Drupal::getContainer();

  $mailer = $container->get('plugin.manager.mail');
  $mailer->mail('example', 'signup_form', $email, .... ['name' => $name]);

  $crm_manager = $container->get('crm.manager');
  $crm_manager->subscribe($name, $email);

  $mailchimp_manager = $container->get('mailchimp.manager');
  $mailchimp_manager->add($name, $email);

  $twitter_manager = $container->get('twitter.manager');
  $tweet = new ThisIsGettingRidiculous();
  $tweet->setMessage('blah blah ' . $name . ' blah blah');
  $twitter_manager->tweet($tweet);
}
</code></pre>
          </section>

          <section>
            <h2>This is bad</h2>
            <ul>
              <li>Form class is doing too many things</li>
              <li>Tightly coupled</li>
              <li>Hard to maintain</li>
              <li>Harder to reuse</li>
            </ul>
          </section>

          <section>
            <h2>Symfony Event Dispatcher</h2>
            <img src="gatwick.jpg" />
          </section>
          <aside class="notes">
            Example of the mediator design pattern.
            Object the encapsulates the communication of other objects.
            Mediator promotes loose coupling by keeping objects from referring to each other explicitly

            Drupal is using ContainerAwareEventDispatcher
          </aside>
        </section>

        <section>
          <section>
            <h2>Dispatching an event</h2>
            <ul>
              <li>Static event class</li>
              <li>Extend the event class</li>
              <li>Dispatch the event</li>
            </ul>
          </section>

          <section>
            <h2>The Static Events Class</h2>
            <pre><code>
final class ExampleModuleEvents {

  /** docBlock */
  const SIGNUP_FORM_SUBMIT = 'module_name.signup_form_submit';
}
            </code></pre>
          </section>

          <section>
            <h2>Extend the event class</h2>
            <pre><code>
use Symfony\Component\EventDispatcher\Event;

class SignupFormEvent extends Event {

  protected $name;
  protected $email;

  public function __construct($name, $email) {
    $this->name = $name;
    $this->email = $email;
  }

  public function getName() { return $this->name; }
  public function getEmail() { return $this->email; }
}
            </code></pre>
          </section>

          <section>
            <h2>Dispatch the event</h2>
            <pre><code>
public function submitForm(array &$form, FormStateInterface $form_state) {
  $name = $form_state->getValue('name');
  $email = $form_state->getValue('email');

  $event = new SignupFormEvent($name, $email);

  $dispatcher = Drupal::service('event_dispatcher');
  $dispatcher->dispatch(ExampleModuleEvents::SIGNUP_FORM_SUBMIT, $event);

  // do something with the data
  // $event->getName();
}
            </code></pre>
          </section>
        </section>

        <section>
          <section>
            <h2>Listen for events</h2>
            <ul>
              <li>Add to services.yaml</li>
              <li>Implement EventSubscriberInterface</li>
              <li>Implement getSubscribers method</li>
            </ul>
          </section>

          <section>
            <h2>services.yaml</h2>
            <pre><code>
services:
  example_crm_module.crm_subscriber:
  class: Drupal\example_crm_module\EventSubscriber\CRMSubscriber
  arguments: ['@crm_manager']
  tags:
    - { name: event_subscriber }
            </code></pre>
          </section>

          <section>
            <h2>Implement EventSubscriberInterface</h2>
            <pre><code>
use Symfony\Component\EventDispatcher\EventSubscriberInterface;

class CRMSubscriber implements EventSubscriberInterface {
  protected $crmManager;

  public function __construct($crmManager) {
    $this->crmManager = $crmManager;
  };

  public static function getSubscribedEvents() {
    $events['module_name.signup_form'][] = array('crmRegister', 0);
    return $events;
  }

  public function crmRegister(SignupFormEvent $event) { ... }
}
            </code></pre>
          </section>

          <section>
            <pre><code>
public function crmRegister($event) {
  $this->crmManager->subscribe($event->getName(), $event->getEmail());

  // $event->stopPropagation();
}
            </code></pre>
          </section>
        </section>

        <section>
          <h2>What is Core doing...</h2>
          <ul>
            <li>ConfigEvents::DELETE, IMPORT, SAVE..</li>
            <li>EntityTypeEvents::CREATE, UPDATE, DELETE..</li>
            <li>KernelEvents::REQUEST, RESPONSE, TERMINATE..</li>
            <li>RoutingEvents::ALTER, DYNAMIC, ETC..</li>
          </ul>
        </section>

        <section>
          <h2>What is Core doing...</h2>
          <ul>
            <li>hook_entity_save, delete, etc</li>
            <li>hook_block_view, etc</li>
            <li>hook_cron</li>
            <li>hook_install</li>
            <li>hook_preprocess</li>
          </ul>
        </section>

        <section>
          <h2>Questions?</h2>
          <p>Eric Smith / <a href="http://twitter.com/ericgsmith">@ericgsmith</a></p>
        </section>
      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
